The muddle release mechanism
============================

.. note:: This is written as part of specifying the mechanism before
   implementation. It should be expanded to be more helpful once the
   implementation is done.

Muddle release files
--------------------
These are a muddle stamp file (specifically, a stamp version file) with extra
fields (at the start). The required part is::

    [RELEASE]
    version = 1.2.3

but there will be optional fields, probably including::

    compression = <mechanism>

(``gzip`` or ``bzip2``, with ``gzip`` the default).

Release files are created using ``muddle release``.

The command::

    $ muddle stamp release Project99 1.2.3

creates a release stamp file called::

    versions/Project99_1.2.3.release

which looks like a normal version 2 stamp file with an extra section after
the ``[STAMP]`` section::

    [RELEASE]
    name = Project99
    version = 1.2.3
    archive = tar
    compression = gzip

You can use the ``-archive`` and ``-compression`` switches to specify the
release archive mechanism and release compression - for instance::

    $ muddle stamp release Project99 1.2.3 -archive tar -compression bzip2

It is also possible to create a "template" release file, with unspecified
release name and version::

    $ muddle stamp release -template

which creates a file called::

    versions/this-is-not-a-file-name.release

with the ``[RELEASE]`` section set to::

    [RELEASE]
    name = <REPLACE THIS>
    version = <REPLACE THIS>
    archive = tar
    compression = gzip

The user is expected to rename the file and edit the ``<REPLACE THIS>`` values
to something sensible. The ``muddle release`` command will not accept release
files where theses field has not been edited (actually, where there are
"naughty" characters in the field).

.. note:: Both release name and release version follow the same rules:

   * the first character must be an ASCI alphanumeric ('A'-'Z', 'a'-'z',
     '0'-'9')
   * any following characters must be ASCII alphanumeric, '-', '_' or '.'

   The release archive must currently be "tar".

   The release compression must currently be one of "gzip" or "bzip2". The
   default is "gzip".

Since release files go in the ``versions/`` directory, ``muddle stamp release``
will add them to the version control system in that directory, just as
``muddle stamp version`` does for its stamp files.

The ``_release`` build target
-----------------------------
This is a new build target, for use as ``muddle build _release``.

It needs to be specified in the build description (if it is not, maybe it
should default to ``_all``, or maybe it should cause a release build to FAIL
INSTANTLY).

For instance::

    builder.add_release_roles(<role-name>)
    builder.add_release_roles([<role-name1>. <role-name2>])
    builder.add_release_deployments(<deployment-name>)
    builder.add_release_deployments([<deployment-name1>, <deployment-name2>])

*Or* just have::

    builder.add_release_labels(<label>)
    builder.add_release_labels([<label1>, <label2>])

where <label> can be wildcarded. Whatever seems simplest.

The ``release_from`` function in the build description
------------------------------------------------------
This looks like::

    def release_from(builder):
        ...

It is the job of this function to generate the release tarball.

.. note:: ``muddle bootstrap`` should probably generate a suitable template.

There will be some extra values retrievable from the builder (by some means),
including

* the name of the release directory, which muddle will already have created,
  and which will be called ``<build-name>-<release-version>.<release-sha1>``
* the full path to the release directory (yes, the name could be derived from
  that, but we can be friendly)
* the release SHA1 and release version

The function works by putting stuff to be released into the release
directory, which muddle will tar up and compress to produce the release
tarball. Muddle will already have copied the release file into the release
directory.


The ``muddle release`` command
------------------------------
For example::

  $ muddle release project99-1.2.3.release

This:

1. Creates a directory called ``project99-1.2.3.release`` and cd's into it

2. Does (the equivalent of) ``muddle unstamp`` using that release file.

3. Copies the release file as ``.muddle/Release``. Also creates a small file
   called ``.muddle/ReleaseSpec``, which contains the basic information
   describing a release (name, version, SHA1 hash of the release file, etc.)
   The existence of this latter file indicates that this is a release build
   tree, and some muddle commands will thus refuse to work in it (notably,
   anything to do with pushing to or pulling from a VCS).

   (Of course, the user can delete the file, but if they do then that's their
   responsibility.)

4. In a release build tree, muddle sets some extra environment variables:
   
   * ``MUDDLE_RELEASE_HASH`` is the SHA1 hash of the release file
   * ``MUDDLE_RELEASE_NAME`` is the name string from the ``name =`` line.
   * ``MUDDLE_RELEASE_VERSION`` is the version string from the ``version =``
     line.

   "Normal" muddle will also create those environment variables, but they will
   be set to ``(unset)``.

5. Does (the equivalent of) ``mudddle build _release``.

6. Creates the release directory,
   ``<build-name>-<release-version>.<release-sha1>``, and copies the release
   file into it.

7. Calls the ``release_from(builder)`` function in the build description
   (obviously it is an error if there isn't one).

      This is probably actually best done with yet another muddle command -
      maybe::

          $ muddle release -???

      This would allow for sequences like:

          $ muddle ../release project99_v1.2.3.release
          ...
          <realise that we have the wrong compiler installed>
          ...
          $ muddle veryclean _all
          $ muddle build _release
          $ muddle release -???

8. Creates a compressed tarball of the release directory, using the
   appropriate compression mechanism.





.. vim: set filetype=rst tabstop=8 softtabstop=2 shiftwidth=2 expandtab:
